<!DOCTYPE HTML>
<html lang="zh-CN">

<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="Java | springboot | springcloud | redis | mysql">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://github.com/chengxy-nds/chengxy-nds.github.io.git">
    <!--SEO-->

<meta name="keywords" content="Redis,分布式锁,Redisson,事务" />


<meta name="description" content="一、什么是限流？为什么要限流？不知道大家有没有做过帝都的地铁，就是进地铁站都要排队的那种，为什么要这样摆长龙转圈圈？答案就是为了限流！因为一趟地铁的运力是有限的，一下挤进去太多人会造成站台的拥挤..." />


<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->

<title>
    
    redis 分布式锁的 5个坑，真是又大又深 |
    
    Java | springboot | springcloud | redis | mysql
</title>

<link rel="alternate" href="/atom.xml" title="Java | springboot | springcloud | redis | mysql" type="application/atom+xml">


<link rel="icon" href="/favicon.ico">

    


<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css">
<link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">

    
<div class="hide">
    <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script>
</div>




    

<meta name="generator" content="Hexo 4.2.0"></head>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
    <header class="main-header"  style="background-image:url(
    http://snippet.shenliyang.com/img/banner.jpg)"
     >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='程序员内点事'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
            <!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
            <h2>
                操蛋的职业，一天到晚学个没完
            </h2>
            
        </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                        <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="https://github.com/chengxy-nds/chengxy-nds.github.io.git">
                        Java | springboot | springcloud | redis | mysql</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                        <li role="presentation" class="text-center">
                            <a href="/"><i class="fa fa-home"></i>
                                首页</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/java/"><i class="fa "></i>
                                Java</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Springboot/"><i class="fa "></i>
                                Springboot</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/分布式/"><i class="fa "></i>
                                分布式</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Redis/"><i class="fa "></i>
                                Redis</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Mysql/"><i class="fa "></i>
                                Mysql</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="redis 分布式锁的 5个坑，真是又大又深">
            
            redis 分布式锁的 5个坑，真是又大又深
            
        </h1>
        <div class="post-meta">
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a class="category-link" href="/categories/Redis/">Redis</a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            <a class="tag-link" href="/tags/Redis/" rel="tag">Redis</a> <a class="tag-link" href="/tags/Redisson/" rel="tag">Redisson</a> <a class="tag-link" href="/tags/%E4%BA%8B%E5%8A%A1/" rel="tag">事务</a> <a class="tag-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" rel="tag">分布式锁</a>
            
        </span>
    </span>
    
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">
            2020/01/26</span>
    </span>
    
    <span class="fa-wrap">
        <i class="fa fa-eye"></i>
        <span id="busuanzi_value_page_pv"></span>
    </span>
    
    
</div>
        
        
    </div>
    
    <div class="post-body post-content">
        <h4 id="一、什么是限流？为什么要限流？"><a href="#一、什么是限流？为什么要限流？" class="headerlink" title="一、什么是限流？为什么要限流？"></a>一、什么是限流？为什么要限流？</h4><p>不知道大家有没有做过帝都的地铁，就是进地铁站都要排队的那种，为什么要这样摆长龙转圈圈？答案就是为了<code>限流</code>！因为一趟地铁的运力是有限的，一下挤进去太多人会造成站台的拥挤、列车的超载，存在一定的安全隐患。同理，我们的程序也是一样，它处理请求的能力也是有限的，一旦请求多到超出它的处理极限就会崩溃。为了不出现最坏的崩溃情况，只能耽误一下大家进站的时间。<br><img src="https://img-blog.csdnimg.cn/202004081524187.png" alt="在这里插入图片描述"><br>限流是保证系统高可用的重要手段！！！</p>
<p>由于互联网公司的流量巨大，系统上线会做一个流量峰值的评估，尤其是像各种秒杀促销活动，为了保证系统不被巨大的流量压垮，会在系统流量到达一定阈值时，拒绝掉一部分流量。</p>
<p>限流会导致用户在短时间内（这个时间段是毫秒级的）系统不可用，一般我们衡量系统处理能力的指标是每秒的<code>QPS</code>或者<code>TPS</code>，假设系统每秒的流量阈值是1000，理论上一秒内有第1001个请求进来时，那么这个请求就会被限流。</p>
<h4 id="二、限流方案"><a href="#二、限流方案" class="headerlink" title="二、限流方案"></a>二、限流方案</h4><h5 id="1、计数器"><a href="#1、计数器" class="headerlink" title="1、计数器"></a>1、计数器</h5><p>Java内部也可以通过原子类计数器<code>AtomicInteger</code>、<code>Semaphore</code>信号量来做简单的限流。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 限流的个数</span></span><br><span class="line">    private int maxCount = <span class="number">10</span>;</span><br><span class="line">    <span class="comment">// 指定的时间内</span></span><br><span class="line">    private long interval = <span class="number">60</span>;</span><br><span class="line">    <span class="comment">// 原子类计数器</span></span><br><span class="line">    private AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 起始时间</span></span><br><span class="line">    private long startTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    public boolean limit(int maxCount, int interval) &#123;</span><br><span class="line">        atomicInteger.addAndGet(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (atomicInteger.get() == <span class="number">1</span>) &#123;</span><br><span class="line">            startTime = System.currentTimeMillis();</span><br><span class="line">            atomicInteger.addAndGet(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 超过了间隔时间，直接重新开始计数</span></span><br><span class="line">        <span class="keyword">if</span> (System.currentTimeMillis() - startTime &gt; interval * <span class="number">1000</span>) &#123;</span><br><span class="line">            startTime = System.currentTimeMillis();</span><br><span class="line">            atomicInteger.set(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 还在间隔时间内,check有没有超过限流的个数</span></span><br><span class="line">        <span class="keyword">if</span> (atomicInteger.get() &gt; maxCount) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2、漏桶算法"><a href="#2、漏桶算法" class="headerlink" title="2、漏桶算法"></a>2、漏桶算法</h5><p>漏桶算法思路很简单，我们把水比作是<code>请求</code>，漏桶比作是<code>系统处理能力极限</code>，水先进入到漏桶里，漏桶里的水按一定速率流出，当流出的速率小于流入的速率时，由于漏桶容量有限，后续进入的水直接溢出（拒绝请求），以此实现限流。<br><img src="https://img-blog.csdnimg.cn/20200408165322945.jpg#pic_center" alt="在这里插入图片描述"></p>
<h5 id="3、令牌桶算法"><a href="#3、令牌桶算法" class="headerlink" title="3、令牌桶算法"></a>3、令牌桶算法</h5><p>令牌桶算法的原理也比较简单，我们可以理解成医院的挂号看病，只有拿到号以后才可以进行诊病。</p>
<p>系统会维护一个令牌（<code>token</code>）桶，以一个恒定的速度往桶里放入令牌（<code>token</code>），这时如果有请求进来想要被处理，则需要先从桶里获取一个令牌（<code>token</code>），当桶里没有令牌（<code>token</code>）可取时，则该请求将被拒绝服务。令牌桶算法通过控制桶的容量、发放令牌的速率，来达到对请求的限制。<br><img src="https://img-blog.csdnimg.cn/20200408165303683.jpg#pic_center" alt="在这里插入图片描述"></p>
<h5 id="4、Redis-Lua"><a href="#4、Redis-Lua" class="headerlink" title="4、Redis + Lua"></a>4、Redis + Lua</h5><p>很多同学不知道<code>Lua</code>是啥？个人理解，<code>Lua</code>脚本和 <code>MySQL</code>数据库的存储过程比较相似，他们执行一组命令，所有命令的执行要么全部成功或者失败，以此达到原子性。也可以把<code>Lua</code>脚本理解为，一段具有业务逻辑的代码块。</p>
<p>而<code>Lua</code>本身就是一种编程语言，虽然<code>redis</code> 官方没有直接提供限流相应的<code>API</code>，但却支持了 <code>Lua</code> 脚本的功能，可以使用它实现复杂的令牌桶或漏桶算法，也是分布式系统中实现限流的主要方式之一。</p>
<p>相比<code>Redis</code>事务，<code>Lua脚本</code>的优点：</p>
<ul>
<li>减少网络开销： 使用<code>Lua</code>脚本，无需向<code>Redis</code> 发送多次请求，执行一次即可，减少网络传输</li>
<li>原子操作：<code>Redis</code> 将整个<code>Lua</code>脚本作为一个命令执行，原子，无需担心并发</li>
<li>复用：<code>Lua</code>脚本一旦执行，会永久保存 <code>Redis</code> 中,，其他客户端可复用</li>
</ul>
<p><code>Lua</code>脚本大致逻辑如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">-- 获取调用脚本时传入的第一个key值（用作限流的 key）</span><br><span class="line">local key = KEYS[<span class="number">1</span>]</span><br><span class="line">-- 获取调用脚本时传入的第一个参数值（限流大小）</span><br><span class="line">local limit = tonumber(ARGV[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">-- 获取当前流量大小</span><br><span class="line">local curentLimit = tonumber(redis.call(<span class="string">'get'</span>, key) or <span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line">-- 是否超出限流</span><br><span class="line"><span class="keyword">if</span> curentLimit + <span class="number">1</span> &gt; limit then</span><br><span class="line">    -- 返回(拒绝)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    -- 没有超出 value + <span class="number">1</span></span><br><span class="line">    redis.call(<span class="string">"INCRBY"</span>, key, <span class="number">1</span>)</span><br><span class="line">    -- 设置过期时间</span><br><span class="line">    redis.call(<span class="string">"EXPIRE"</span>, key, <span class="number">2</span>)</span><br><span class="line">    -- 返回(放行)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<ul>
<li>通过<code>KEYS[1]</code> 获取传入的key参数 </li>
<li>通过<code>ARGV[1]</code>获取传入的<code>limit</code>参数 </li>
<li><code>redis.call</code>方法，从缓存中<code>get</code>和<code>key</code>相关的值，如果为<code>null</code>那么就返回0 </li>
<li>接着判断缓存中记录的数值是否会大于限制大小，如果超出表示该被限流，返回0 </li>
<li>如果未超过，那么该key的缓存值+1，并设置过期时间为1秒钟以后，并返回缓存值+1</li>
</ul>
<p>这种方式是本文推荐的方案，具体实现会在后边做细说。</p>
<h5 id="5、网关层限流"><a href="#5、网关层限流" class="headerlink" title="5、网关层限流"></a>5、网关层限流</h5><p>限流常在网关这一层做，比如<code>Nginx</code>、<code>Openresty</code>、<code>kong</code>、<code>zuul</code>、<code>Spring Cloud Gateway</code>等，而像<code>spring cloud - gateway</code>网关限流底层实现原理，就是基于<code>Redis + Lua</code>，通过内置<code>Lua</code>限流脚本的方式。<br><img src="https://img-blog.csdnimg.cn/20200408165829339.png" alt="在这里插入图片描述"></p>
<h4 id="三、Redis-Lua-限流实现"><a href="#三、Redis-Lua-限流实现" class="headerlink" title="三、Redis + Lua 限流实现"></a>三、Redis + Lua 限流实现</h4><p>下面我们通过<code>自定义注解</code>、<code>aop</code>、<code>Redis + Lua</code> 实现限流，步骤会比较详细，为了小白能让快速上手这里啰嗦一点，有经验的老鸟们多担待一下。</p>
<h5 id="1、环境准备"><a href="#1、环境准备" class="headerlink" title="1、环境准备"></a>1、环境准备</h5><p><code>springboot</code> 项目创建地址：<a href="https://start.spring.io，很方便实用的一个工具。" target="_blank" rel="noopener">https://start.spring.io，很方便实用的一个工具。</a><br><img src="https://img-blog.csdnimg.cn/2020040812215172.png" alt="在这里插入图片描述"></p>
<h5 id="2、引入依赖包"><a href="#2、引入依赖包" class="headerlink" title="2、引入依赖包"></a>2、引入依赖包</h5><p>pom文件中添加如下依赖包，比较关键的就是 <code>spring-boot-starter-data-redis</code> 和 <code>spring-boot-starter-aop</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;<span class="regexp">/groupId&gt;</span></span><br><span class="line"><span class="regexp">        &lt;artifactId&gt;spring-boot-starter-web&lt;/</span>artifactId&gt;</span><br><span class="line">    &lt;<span class="regexp">/dependency&gt;</span></span><br><span class="line"><span class="regexp">    &lt;dependency&gt;</span></span><br><span class="line"><span class="regexp">        &lt;groupId&gt;org.springframework.boot&lt;/g</span>roupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-data-redis&lt;<span class="regexp">/artifactId&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;<span class="regexp">/groupId&gt;</span></span><br><span class="line"><span class="regexp">        &lt;artifactId&gt;spring-boot-starter-aop&lt;/</span>artifactId&gt;</span><br><span class="line">    &lt;<span class="regexp">/dependency&gt;</span></span><br><span class="line"><span class="regexp">    &lt;dependency&gt;</span></span><br><span class="line"><span class="regexp">        &lt;groupId&gt;com.google.guava&lt;/g</span>roupId&gt;</span><br><span class="line">        &lt;artifactId&gt;guava&lt;<span class="regexp">/artifactId&gt;</span></span><br><span class="line"><span class="regexp">        &lt;version&gt;21.0&lt;/</span>version&gt;</span><br><span class="line">    &lt;<span class="regexp">/dependency&gt;</span></span><br><span class="line"><span class="regexp">    &lt;dependency&gt;</span></span><br><span class="line"><span class="regexp">        &lt;groupId&gt;org.springframework.boot&lt;/g</span>roupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-test&lt;<span class="regexp">/artifactId&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.commons&lt;<span class="regexp">/groupId&gt;</span></span><br><span class="line"><span class="regexp">        &lt;artifactId&gt;commons-lang3&lt;/</span>artifactId&gt;</span><br><span class="line">    &lt;<span class="regexp">/dependency&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    &lt;dependency&gt;</span></span><br><span class="line"><span class="regexp">        &lt;groupId&gt;org.springframework.boot&lt;/g</span>roupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-test&lt;<span class="regexp">/artifactId&gt;</span></span><br><span class="line"><span class="regexp">        &lt;scope&gt;test&lt;/</span>scope&gt;</span><br><span class="line">        &lt;exclusions&gt;</span><br><span class="line">            &lt;exclusion&gt;</span><br><span class="line">                &lt;groupId&gt;org.junit.vintage&lt;<span class="regexp">/groupId&gt;</span></span><br><span class="line"><span class="regexp">                &lt;artifactId&gt;junit-vintage-engine&lt;/</span>artifactId&gt;</span><br><span class="line">            &lt;<span class="regexp">/exclusion&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>exclusions&gt;</span><br><span class="line">    &lt;<span class="regexp">/dependency&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>dependencies&gt;</span><br></pre></td></tr></table></figure>
<h5 id="3、配置application-properties"><a href="#3、配置application-properties" class="headerlink" title="3、配置application.properties"></a>3、配置application.properties</h5><p>在 <code>application.properties</code> 文件中配置提前搭建好的 <code>redis</code> 服务地址和端口。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.redis.host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line">spring.redis.port=<span class="number">6379</span></span><br></pre></td></tr></table></figure>
<h5 id="4、配置RedisTemplate实例"><a href="#4、配置RedisTemplate实例" class="headerlink" title="4、配置RedisTemplate实例"></a>4、配置RedisTemplate实例</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">RedisLimiterHelper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public RedisTemplate&lt;<span class="built_in">String</span>, Serializable&gt; limitRedisTemplate(LettuceConnectionFactory redisConnectionFactory) &#123;</span><br><span class="line">        RedisTemplate&lt;<span class="built_in">String</span>, Serializable&gt; template = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        template.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">        template.setValueSerializer(<span class="keyword">new</span> GenericJackson2JsonRedisSerializer());</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>限流类型枚举类</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author <span class="variable">fu</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>限流类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date </span>2020/4/8 13:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public enum LimitType &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CUSTOMER,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求者IP</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    IP;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5、自定义注解"><a href="#5、自定义注解" class="headerlink" title="5、自定义注解"></a>5、自定义注解</h5><p>我们自定义个<code>@Limit</code>注解，注解类型为<code>ElementType.METHOD</code>即作用于方法上。</p>
<p><code>period</code>表示请求限制时间段，<code>count</code>表示在<code>period</code>这个时间段内允许放行请求的次数。<code>limitType</code>代表限流的类型，可以根据<code>请求的IP</code>、<code>自定义key</code>，如果不传<code>limitType</code>属性则默认用方法名作为默认key。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author <span class="variable">fu</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>自定义限流注解</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date </span>2020/4/8 13:15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Inherited</span><br><span class="line">@Documented</span><br><span class="line">public @interface Limit &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 名字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">String</span> name() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">String</span> key() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Key的前缀</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">String</span> prefix() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 给定的时间范围 单位(秒)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    int period();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 一定时间内最多访问次数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    int count();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 限流的类型(用户自定义key 或者 请求ip)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    LimitType limitType() <span class="keyword">default</span> LimitType.CUSTOMER;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6、切面代码实现"><a href="#6、切面代码实现" class="headerlink" title="6、切面代码实现"></a>6、切面代码实现</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author <span class="variable">fu</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description </span>限流切面实现</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date </span>2020/4/8 13:04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Aspect</span><br><span class="line">@Configuration</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">LimitInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">static</span> final Logger logger = LoggerFactory.getLogger(LimitInterceptor.class);</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">static</span> final <span class="built_in">String</span> UNKNOWN = <span class="string">"unknown"</span>;</span><br><span class="line"></span><br><span class="line">    private final RedisTemplate&lt;<span class="built_in">String</span>, Serializable&gt; limitRedisTemplate;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    public LimitInterceptor(RedisTemplate&lt;<span class="built_in">String</span>, Serializable&gt; limitRedisTemplate) &#123;</span><br><span class="line">        <span class="keyword">this</span>.limitRedisTemplate = limitRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="variable">pjp</span></span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author <span class="variable">fu</span></span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description </span>切面</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date </span>2020/4/8 13:04</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @Around(<span class="string">"execution(public * *(..)) &amp;&amp; @annotation(com.xiaofu.limit.api.Limit)"</span>)</span><br><span class="line">    public <span class="built_in">Object</span> interceptor(ProceedingJoinPoint pjp) &#123;</span><br><span class="line">        MethodSignature signature = (MethodSignature) pjp.getSignature();</span><br><span class="line">        Method method = signature.getMethod();</span><br><span class="line">        Limit limitAnnotation = method.getAnnotation(Limit.class);</span><br><span class="line">        LimitType limitType = limitAnnotation.limitType();</span><br><span class="line">        <span class="built_in">String</span> name = limitAnnotation.name();</span><br><span class="line">        <span class="built_in">String</span> key;</span><br><span class="line">        int limitPeriod = limitAnnotation.period();</span><br><span class="line">        int limitCount = limitAnnotation.count();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 根据限流类型获取不同的key ,如果不传我们会以方法名作为key</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">switch</span> (limitType) &#123;</span><br><span class="line">            <span class="keyword">case</span> IP:</span><br><span class="line">                key = getIpAddress();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CUSTOMER:</span><br><span class="line">                key = limitAnnotation.key();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                key = StringUtils.upperCase(method.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ImmutableList&lt;<span class="built_in">String</span>&gt; keys = ImmutableList.of(StringUtils.join(limitAnnotation.prefix(), key));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">String</span> luaScript = buildLuaScript();</span><br><span class="line">            RedisScript&lt;<span class="built_in">Number</span>&gt; redisScript = <span class="keyword">new</span> DefaultRedisScript&lt;&gt;(luaScript, <span class="built_in">Number</span>.class);</span><br><span class="line">            <span class="built_in">Number</span> count = limitRedisTemplate.execute(redisScript, keys, limitCount, limitPeriod);</span><br><span class="line">            logger.info(<span class="string">"Access try count is &#123;&#125; for name=&#123;&#125; and key = &#123;&#125;"</span>, count, name, key);</span><br><span class="line">            <span class="keyword">if</span> (count != <span class="literal">null</span> &amp;&amp; count.intValue() &lt;= limitCount) &#123;</span><br><span class="line">                <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"You have been dragged into the blacklist"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getLocalizedMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"server exception"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author <span class="variable">fu</span></span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description </span>编写 redis Lua 限流脚本</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date </span>2020/4/8 13:24</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="built_in">String</span> buildLuaScript() &#123;</span><br><span class="line">        StringBuilder lua = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        lua.append(<span class="string">"local c"</span>);</span><br><span class="line">        lua.append(<span class="string">"\nc = redis.call('get',KEYS[1])"</span>);</span><br><span class="line">        <span class="comment">// 调用不超过最大值，则直接返回</span></span><br><span class="line">        lua.append(<span class="string">"\nif c and tonumber(c) &gt; tonumber(ARGV[1]) then"</span>);</span><br><span class="line">        lua.append(<span class="string">"\nreturn c;"</span>);</span><br><span class="line">        lua.append(<span class="string">"\nend"</span>);</span><br><span class="line">        <span class="comment">// 执行计算器自加</span></span><br><span class="line">        lua.append(<span class="string">"\nc = redis.call('incr',KEYS[1])"</span>);</span><br><span class="line">        lua.append(<span class="string">"\nif tonumber(c) == 1 then"</span>);</span><br><span class="line">        <span class="comment">// 从第一次调用开始限流，设置对应键值的过期</span></span><br><span class="line">        lua.append(<span class="string">"\nredis.call('expire',KEYS[1],ARGV[2])"</span>);</span><br><span class="line">        lua.append(<span class="string">"\nend"</span>);</span><br><span class="line">        lua.append(<span class="string">"\nreturn c;"</span>);</span><br><span class="line">        <span class="keyword">return</span> lua.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author <span class="variable">fu</span></span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description </span>获取id地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date </span>2020/4/8 13:24</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="built_in">String</span> getIpAddress() &#123;</span><br><span class="line">        HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();</span><br><span class="line">        <span class="built_in">String</span> ip = request.getHeader(<span class="string">"x-forwarded-for"</span>);</span><br><span class="line">        <span class="keyword">if</span> (ip == <span class="literal">null</span> || ip.length() == <span class="number">0</span> || UNKNOWN.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getHeader(<span class="string">"Proxy-Client-IP"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ip == <span class="literal">null</span> || ip.length() == <span class="number">0</span> || UNKNOWN.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getHeader(<span class="string">"WL-Proxy-Client-IP"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ip == <span class="literal">null</span> || ip.length() == <span class="number">0</span> || UNKNOWN.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getRemoteAddr();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ip;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h5 id="7、控制层实现"><a href="#7、控制层实现" class="headerlink" title="7、控制层实现"></a>7、控制层实现</h5><p>我们将<code>@Limit</code>注解作用在需要进行限流的接口方法上，下边我们给方法设置<code>@Limit</code>注解，在<code>10秒</code>内只允许放行<code>3个</code>请求，这里为直观一点用<code>AtomicInteger</code>计数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: fu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@RestController</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">LimiterController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">static</span> final AtomicInteger ATOMIC_INTEGER_1 = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">    private <span class="keyword">static</span> final AtomicInteger ATOMIC_INTEGER_2 = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">    private <span class="keyword">static</span> final AtomicInteger ATOMIC_INTEGER_3 = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author <span class="variable">fu</span></span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date </span>2020/4/8 13:42</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @Limit(key = <span class="string">"limitTest"</span>, period = <span class="number">10</span>, count = <span class="number">3</span>)</span><br><span class="line">    @GetMapping(<span class="string">"/limitTest1"</span>)</span><br><span class="line">    public int testLimiter1() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ATOMIC_INTEGER_1.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author <span class="variable">fu</span></span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date </span>2020/4/8 13:42</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @Limit(key = <span class="string">"customer_limit_test"</span>, period = <span class="number">10</span>, count = <span class="number">3</span>, limitType = LimitType.CUSTOMER)</span><br><span class="line">    @GetMapping(<span class="string">"/limitTest2"</span>)</span><br><span class="line">    public int testLimiter2() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ATOMIC_INTEGER_2.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author <span class="variable">fu</span></span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description </span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date </span>2020/4/8 13:42</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @Limit(key = <span class="string">"ip_limit_test"</span>, period = <span class="number">10</span>, count = <span class="number">3</span>, limitType = LimitType.IP)</span><br><span class="line">    @GetMapping(<span class="string">"/limitTest3"</span>)</span><br><span class="line">    public int testLimiter3() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ATOMIC_INTEGER_3.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="8、测试"><a href="#8、测试" class="headerlink" title="8、测试"></a>8、测试</h5><p>测试<strong>预期</strong>：连续请求3次均可以成功，第4次请求被拒绝。接下来看一下是不是我们预期的效果，请求地址：<code>http://127.0.0.1:8080/limitTest1</code>，用<code>postman</code>进行测试，有没有<code>postman</code> url直接贴浏览器也是一样。</p>
<p><img src="https://img-blog.csdnimg.cn/20200408141131360.png" alt="在这里插入图片描述"><br>可以看到第四次请求时，应用直接拒绝了请求，说明我们的 Springboot + aop + lua 限流方案搭建成功。<br><img src="https://img-blog.csdnimg.cn/20200408141247524.png" alt="在这里插入图片描述"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>以上 <code>springboot + aop + Lua</code> 限流实现是比较简单的，旨在让大家认识下什么是限流？如何做一个简单的限流功能，面试要知道这是个什么东西。上面虽然说了几种实现限流的方案，但选哪种还要结合具体的业务场景，不能为了用而用。</p>

    </div>
    
    <div class="reward" ontouchstart>
    <div class="reward-wrap">赏
        <div class="reward-box">
            
            <span class="reward-type">
                <img class="alipay" src="/支付宝支付码.jpg"><b>支付宝打赏</b>
            </span>
            
            
            <span class="reward-type">
                <img class="wechat" src="/微信支付码.png"><b>微信打赏</b>
            </span>
            
        </div>
    </div>
    <p class="reward-tip">
        赞赏是不耍流氓的鼓励
    </p>
</div>
    
    <div class="post-footer">
        <div>
            
            转载声明：
            转载请注明出处
            
            
        </div>
        <div>
            
        </div>
    </div>
</article>
<div class="article-nav prev-next-wrap clearfix">
    
    <a href="/2020/01/26/Springboot%202.x%20%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E9%87%8D%E5%A4%8D%E6%8F%90%E4%BA%A4%20%EF%BC%88%E6%9C%AC%E5%9C%B0%E9%94%81%E7%9A%84%E5%AE%9E%E8%B7%B5%EF%BC%89/" class="pre-post btn btn-default" title='Springboot 2.x 如何解决重复提交 （本地锁的实践）'>
        <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
        <span class="hidden-xs">
            Springboot 2.x 如何解决重复提交 （本地锁的实践）</span>
    </a>
    
    
    <a href="/2020/01/26/3%E4%B8%87%E5%AD%97%E6%80%BB%E7%BB%93%EF%BC%8CMysql%E4%BC%98%E5%8C%96%E4%B9%8B%E7%B2%BE%E9%AB%93/" class="next-post btn btn-default" title='3万字总结，Mysql优化之精髓'>
        <span class="hidden-lg">下一篇</span>
        <span class="hidden-xs">
            3万字总结，Mysql优化之精髓</span><i class="fa fa-angle-right fa-fw"></i>
    </a>
    
</div>

<div id="comments">
    

<div id="vcomments" class="valine"></div>

<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

<script>
new Valine({
    av: AV,
    el: '#vcomments',
    appId: 'xOKV9J4UeQAtVkvnJC7Kq2Jn-gzGzoHsz',
    appKey: 'erIpQac4azoCmgfBB7Dl9maa',
    placeholder: '说点什么吧',
    notify: false,
    verify: true,
    avatar: 'mm',
    meta: 'nick,mail'.split(','),
    pageSize: '10',
    path: window.location.pathname,
    lang: 'zh-CN'.toLowerCase()
})
</script>


</div>



                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">
            文章目录
        </h3>
        
        <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#一、什么是限流？为什么要限流？"><span class="toc-text">一、什么是限流？为什么要限流？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二、限流方案"><span class="toc-text">二、限流方案</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1、计数器"><span class="toc-text">1、计数器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2、漏桶算法"><span class="toc-text">2、漏桶算法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3、令牌桶算法"><span class="toc-text">3、令牌桶算法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4、Redis-Lua"><span class="toc-text">4、Redis + Lua</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5、网关层限流"><span class="toc-text">5、网关层限流</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三、Redis-Lua-限流实现"><span class="toc-text">三、Redis + Lua 限流实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1、环境准备"><span class="toc-text">1、环境准备</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2、引入依赖包"><span class="toc-text">2、引入依赖包</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3、配置application-properties"><span class="toc-text">3、配置application.properties</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4、配置RedisTemplate实例"><span class="toc-text">4、配置RedisTemplate实例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5、自定义注解"><span class="toc-text">5、自定义注解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6、切面代码实现"><span class="toc-text">6、切面代码实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7、控制层实现"><span class="toc-text">7、控制层实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8、测试"><span class="toc-text">8、测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol>
        
    </div>
</aside>
                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>
<a id="back-to-top" class="icon-btn hide">
    <i class="fa fa-chevron-up"></i>
</a>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
    访问量:
    <strong id="busuanzi_value_site_pv">
        <i class="fa fa-spinner fa-spin"></i>
    </strong>
    &nbsp; | &nbsp;
    访客数:
    <strong id="busuanzi_value_site_uv">
        <i class="fa fa-spinner fa-spin"></i>
    </strong>
    
</div>
            </div>
            <div class="col-sm-12">
                <span>Copyright &copy;
                    2020
                    
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/app.js?rev=@@hash.js"></script>

</body>
</html>